---
title: "ANN-keras system identification example"
author: "Hultmann Ayala, Helon Vicente"
date: "`r Sys.Date()`"
output: rmarkdown::github_document
#output: rmarkdown::html_vignette
---

In order to compile this example, please run

> rmarkdown::render("vignettes/ann.Rmd")

Load libraries 

```{r}
library(narmax)
library(tidyverse)
set.seed(0) 
```

Read system data (see Example 4 (p. 16) in https://ieeexplore.ieee.org/stamp/stamp.jsp?arnumber=80202 )
```{r}
load("../examples/narendra.RData")
ne = length(ue) # amount of data - estimation
nv = length(uv) # amount of data - validation

# normalize data: mean = 0, sd = 1
y = scale(c(ye,yv))
u = scale(c(ue,uv))
ye1 = y[1:800]
yv1 = y[801:1600]
ue1 = u[1:800]
uv1 = u[801:1600]

```

Plot system's input-output data

```{r}
df = data.frame(time=1:ne,ye1,ue1,yv1,uv1) %>% gather(variable, measurement, -time)

ggplot(df) + geom_line(aes(x=time,y = measurement)) + facet_grid(variable ~.)

```

Define the parameters of the model

```{r}
# select model orders
oy = 1:3
ou = 1:2

# model parameters
nrn = c(128,128,128,128)
#acf = "tanh"
acf = "sigmoid"
mdl = ann(oy,ou,nrn,acf) # create model variable
```

Estimate the parameters of the model

```{r}
mdl = estimate(mdl,ye1,ue1,lr = 1e-4, epochs = 200, batch_size = 128, verbose = 0)
print(mdl$mdl)
```

Calculate the predictions of the model in OSA and FR
```{r}

# PREDICTIONS - estimation phase
yhe_1 = predict(mdl,ye1,ue1,K = 1) # one-step-ahead
yhe_0 = predict(mdl,ye1,ue1,K = 0) # free-run

# PREDICTIONS - validation phase
yhv_1 = predict(mdl,yv1,uv1,K = 1) # one-step-ahead
yhv_0 = predict(mdl,yv1,uv1,K = 0) # free-run

```

Calculate the residuals in OSA and FR

```{r}

# RESIDUALS - estimation phase
ehe_1 = ye1[mdl$maxLag:ne] - yhe_1
ehe_0 = ye1[mdl$maxLag:ne] - yhe_0

R2e_1 = calcR2(ye1[mdl$maxLag:ne],yhe_1)
R2e_0 = calcR2(ye1[mdl$maxLag:ne],yhe_0)

# RESIDUALS - validation phase
ehv_1 = yv1[mdl$maxLag:ne] - yhv_1
ehv_0 = yv1[mdl$maxLag:ne] - yhv_0

R2v_1 = calcR2(yv1[mdl$maxLag:ne],yhv_1)
R2v_0 = calcR2(yv1[mdl$maxLag:ne],yhv_0)

print(paste("R2 est (OSA & FR): ", R2e_1,R2e_0))
print(paste("R2 val (OSA & FR): ", R2v_1,R2v_0))

```

Store data in data frames for nice plotting
```{r}

df_e = tibble(time = mdl$maxLag:ne,Y=ye1[mdl$maxLag:ne],Yp = yhe_1,Ys = yhe_0,Ep = ehe_1,Es = ehe_0) %>% gather(variable, measurement, -time)
df_v = tibble(time = mdl$maxLag:nv,Y=yv1[mdl$maxLag:ne],Yp = yhv_1,Ys = yhv_0,Ep = ehv_1,Es = ehv_0) %>% gather(variable, measurement, -time)

```

FR plot (predictions) in estimation (1st) and validation (2nd)
```{r}
ggplot(filter(df_e, variable %in% c("Y","Ys"))) +
  geom_line(aes(x = time,y = measurement,color=variable)) +
  labs(title = "Free-run simulation\n", x = "Sample", y = "Output", color = "\n") +
  scale_color_manual(labels = c("Measurement", "Prediction"), values = c("black", "blue")) +
  theme(legend.position="bottom")

ggplot(filter(df_v, variable %in% c("Y","Ys"))) +
  geom_line(aes(x = time,y = measurement,color=variable)) +
  labs(title = "Free-run simulation\n", x = "Sample", y = "Output", color = "\n") +
  scale_color_manual(labels = c("Measurement", "Prediction"), values = c("black", "blue")) +
  theme(legend.position="bottom")

```

OSA plot (predictions) in estimation (1st) and validation (2nd)
```{r}
ggplot(filter(df_e, variable %in% c("Y","Yp"))) +
  geom_line(aes(x = time,y = measurement,color=variable)) +
  labs(title = "One-step-ahead prediction\n", x = "Sample", y = "Output", color = "\n") +
  scale_color_manual(labels = c("Measurement", "Prediction"), values = c("black", "blue")) +
  theme(legend.position="none")

ggplot(filter(df_v, variable %in% c("Y","Yp"))) +
  geom_line(aes(x = time,y = measurement,color=variable)) +
  labs(title = "One-step-ahead prediction\n", x = "Sample", y = "Output", color = "\n") +
  scale_color_manual(labels = c("Measurement", "Prediction"), values = c("black", "blue")) +
  theme(legend.position="none")

```

FR residual plot in estimation (1st) and validation (2nd)
```{r}
# residuals
ggplot(filter(df_e, variable %in% c("Es"))) +
  geom_line(aes(x = time,y = measurement)) +
  labs(title = "Free-run simulation error\n", x = "Sample", y = "Error")

# residuals
ggplot(filter(df_v, variable %in% c("Es"))) +
  geom_line(aes(x = time,y = measurement)) +
  labs(title = "Free-run simulation error\n", x = "Sample", y = "Error")

```

OSA residual plot in estimation (1st) and validation (2nd)

```{r}
ggplot(filter(df_e, variable %in% c("Ep"))) +
  geom_line(aes(x = time,y = measurement)) +
  labs(title = "One-step-ahead error\n", x = "Sample", y = "Error")

ggplot(filter(df_v, variable %in% c("Ep"))) +
  geom_line(aes(x = time,y = measurement)) +
  labs(title = "One-step-ahead error\n", x = "Sample", y = "Error")

```

Print correlation-based tests

```{r}
uxcorr = ue1[mdl$maxLag:ne]  # u for corr tests
xcorrel(ehe_1,uxcorr)
# plot(xc)
```

